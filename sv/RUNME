#!/bin/bash

#----------------------------------------
# File: RUNME.sh
# Description: Bash script for automated testing
# Primary Author: Jack Barnes
# Other Contributors: Dominic Murphy
# Notes: Must be run on Hind to allow GCC cross compiler to be used.
#----------------------------------------

main()
{
    if [ $host != $hind ]
    then
        echo "Error: This script requires hind CAD server. Exiting..."
    exit 1
    fi

    if [ ${#} = "0" ]
    then
        RUN_PROC=1
    fi
    while [ "$1" != "" ]; do
        case $1 in
            (-h|--help)     usage;;
            (-a|--all)      RUN_IF=1
                            RUN_ID=1
                            RUN_EX=1
                            RUN_MEM=1
                            RUN_WB=1
                            RUN_FU=1
                            RUN_BP=1
                            RUN_PROC=1;;
            (-proc)         RUN_PROC=1;;
            (-if)           RUN_IF=1;;
            (-id)           RUN_ID=1;;
            (-ex)           RUN_EX=1;;
            (-mem)          RUN_MEM=1;;
            (-wb)           RUN_WB=1;;
            (-fu)           RUN_FU=1;;
            (-bp)           RUN_BP=1;;
            (--specific=*)  SPECIFIC="$SPECIFIC ${1//"--specific="/}";;
            (-s=*)          SPECIFIC="$SPECIFIC ${1//"-s="/}";;
            (-gui)          GUI_VAR="+gui"
                            echo "Include GUI";;
            (-q|--quiet)    QUIET=1;;
            (-v|--verbose)  VERBOSE=1;;
            (-plusargs=*)   PLUSARGS=${1//"-plusargs="/};;
            (-syn*)         RUN_SYN=1
                            SYNARGS=$1;;
            (-pnr*)         RUN_PNR=1
                            PNRARGS=$1;;
            (-*)            echo "Unknown argument. Try --help for information";;
            (*)             echo "No arguments defined";;
        esac
        shift
    done

    if [ -n "$SPECIFIC" ]
    then
        specific
    fi
    if [ -n "$RUN_IF" ]
    then
        MODULES=(pcinc pc)
        stages "IF"
    fi
    if [ -n "$RUN_ID" ]
    then
        MODULES=(decoder registers signextend)
        stages "ID"
    fi
    if [ -n "$RUN_EX" ]
    then
        MODULES=(alu acc_control ex_mult ex_control)
        stages "EX"
    fi
    if [ -n "$RUN_MEM" ]
    then
        MODULES=()
        stages "MEM"
    fi
    if [ -n "$RUN_WB" ]
    then
        MODULES=(mux muxthree)
        stages "WB"
    fi
    if [ -n "$RUN_FU" ]
    then
        MODULES=(FU)
        stages "FU"
    fi
    if [ -n "$RUN_BP" ]
    then
        MODULES=(BP)
        stages "BP"
    fi
    if [ -n "$RUN_PROC" ]
    then
        proc
    fi
    if [ -n "$RUN_SYN" ]
    then
        if [[ $SYNARGS = *"-syn="* ]]
        then
            PROCLOC="test/processor_tb.sv syn/work_${SYNARGS/-syn=/}/processor_synth.v syn/0.35um_Technologu_HDL_Files/*.v"
            NCARGS=$"$NCARGS +define+SDF_FILE=syn/work_${SYNARGS/-syn=/}/design.sdf"
            proc
        else
            summarytext=$"${summarytext} No clock period selected. Avaiable periods are:
"
        fi
    fi
    if [ -n "$RUN_PNR" ]
    then
        if [[ $PNRARGS = *"-pnr="* ]]
        then
            PROCLOC="test/processor_tb.sv syn/work_${PNRARGS/-pnr=/}/processor_net.v syn/0.35um_Technologu_HDL_Files/*.v"
            NCARGS=$"$NCARGS +define+SDF_FILE=syn/work_${PNRARGS/-pnr=/}/processor.sdf"
            proc
        else
            summarytext=$"${summarytext} No clock period selected. Avaiable periods are:
"
        fi
    fi

    padding
    echo -e "\n$newtext" >> run.log
    coltext=${newtext//PASS/\\e[92mPASS\\e[39m}
    newtext=${coltext//FAIL/\\e[1;4;91mFAIL\\e[21;24;39m}
    echo -e "\n$newtext"

    exit 0
}

usage()
{
    echo "
    -h,--help          Displays this message
    -a,--all           Runs all test conditions
    -proc              Runs the top level processor test
    -if                Runs the instruction fetch tests
    -id                Runs the instruction decode tests
    -ex                Runs the execute tests
    -mem               Runs the memory tests
    -wb                Runs the write back tests
    -fu                Runs the forwarding unit test
    -bp                Runs the branch prediction test
    -s,--specific=\"\"   Runs a singular test on 'module'
    -gui               Runs the gui
    -q,--quiet         Runs the tests with little feedback.
                       Default case shows errors within module tests
    -syn               Runs the test cases on the synthesised design
    -pnr               Runs the test cases on the placed and routed design
     NO ARGUMENT       Runs the top level processor test (Without GUI)

    -plusargs=\"\"       Include plusargs to any command to set arguments
                       within the testbench itself. Full list below.
                       Arguments can be chained by including a single
                       comma between them. Left blank if not set
        \"+test=<>\"     Used within the top level processor to choose
                       the testcase
    "
    exit 1
}

proc()
{
    echo "##### Testing the entire processor"
    if [[ $PLUSARGS = *"+test"* ]]
    then
        templog=$(ncverilog $NCARGS $GUI_VAR "+incdir+src/+test/" $PLUSARGS $PROCLOC)
        if [ "$?" = "0" ]
        then
            summarytext=$"${summarytext}processor testcase ${PLUSARGS/+test=/} .. PASS
"
            summarytext=${summarytext/+clk_p=*[0-9]/}
        else
            summarytext=$"${summarytext}processor testcase ${PLUSARGS/+test=/} ..  FAIL
"
            summarytext=${summarytext/+clk_p=*[0-9]/}
            if [ -z "$QUIET" ]
            then
                echo "$templog"
            fi
        fi
        echo "$templog" >> run.log
        if [ -n "$VERBOSE" ]
        then
            echo "$templog"
        fi
    else
        for test in {1..7}
        do
            templog=$(ncverilog $NCARGS $GUI_VAR "+incdir+src/+test/" $PLUSARGS "+test="$test $PROCLOC)
            if [ "$?" = "0" ]
            then
                summarytext="${summarytext}processor testcase $test .. PASS
"
            else
                summarytext="${summarytext}processor testcase $test .. FAIL
"
                if [ -z "$QUIET" ]
                then
                    echo "$templog"
                fi
            fi
            echo "$templog" >> run.log
            if [ -n "$VERBOSE" ]
            then
                echo "$templog"
            fi
        done
    fi
    echo "      .. done"
}

stages()
{
    echo "##### Testing the $1 stage"
    for i in ${MODULES[@]};
    do
        echo "  ### Testing ${i}.sv"
        templog=$(ncverilog $NCARGS $GUI_VAR +incdir+src/ $PLUSARGS "test/${i}_tb.sv" src/${i}.sv)
        if [ "$?" = "0" ]
        then
            summarytext="${summarytext}$i .. PASS
"
        else
            summarytext="${summarytext}$i .. FAIL
"
            if [ -z "$QUIET" ]
            then
                echo "$templog"
            fi
        fi
        echo "$templog" >> run.log
        if [ -n "$VERBOSE" ]
        then
            echo "$templog"
        fi
        echo "      .. done"
    done
    echo "##### .. done"
}

specific()
{
    for i in ${SPECIFIC[@]}
    do
        echo "##### Testing ${i}.sv"
        templog=$(ncverilog $NCARGS $GUI_VAR +incdir+src/ $PLUSARGS "test/${i}_tb.sv" src/${i}.sv)
        if [ "$?" = "0" ]
        then
            summarytext="${summarytext}$i .. PASS
"
        else
            summarytext="${summarytext}$i .. FAIL
"
            if [ -z "$QUIET" ]
            then
                echo "$templog"
            fi
        fi
        echo "$templog" >> run.log
        if [ -n "$VERBOSE" ]
        then
            echo "$templog"
        fi
        echo "      .. done"
    done
}

padding()
{
    while read a
    do
       declare -i NUMCS
       TOTAL=${#a}
       NUMCS=$TOTAL
       if [ $NUMCS -gt 8 ]
       then
           NUMCS=$NUMCS-8
           newtext="${newtext}${a:0:$NUMCS} "
           for (( j=1; j<=14-$NUMCS; j++ ))
           do
               newtext="${newtext}."
           done
           newtext="${newtext} ${a:$TOTAL-4:$TOTAL}\n"
       fi
    done <<< "$summarytext"
}

# Check if mips cross-compiler is avaiable. If not then adjust PATH variable.
if [[ ! $PATH =~ .*/opt/esdcad/cross/bin.* ]]; then
    export PATH=/opt/esdcad/cross/bin:$PATH
fi

# complib.so is needed for DPI functions called in the testbench. This library will compile asm files
# and provide an interface to fetch instructions.
if [ ! -f ./complib.so ]; then
    echo "Warning: complib.so library file not found, will compile it from source."
    gcc ../sw/complib.c -fPIC -shared -o complib.so -I /opt/cad/soft/cadence/ius/tools/inca/include
    #gcc ../sw/complib.c -c -o complib.so -I /opt/esdcad/software/synopsys/linux/vcs-mx_D-2009.12-5/include
fi

echo -e 'run.log
' > run.log
summarytext=""
newtext=""
PROCLOC="test/processor_tb.sv src/*.sv"
NCARGS="+nc64bit +ncaccess+r -sv -q +nctimescale+100ps/1fs -sv_lib complib.so"
host=`hostname`
hind="hind.ecs.soton.ac.uk"
main "$@"
