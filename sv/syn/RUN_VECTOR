#!/bin/tcsh

#------------------------------------------------------------------------------
# File              : RUN_VECTOR
# Description       : Tcsh script to create test vectors for the design
# Primary Author    : Ethan Bishop
# Other Contributors:
#------------------------------------------------------------------------------

set host=`hostname`
set hind="hind.ecs.soton.ac.uk"
set hart="hart.ecs.soton.ac.uk"

if ("$1" == "--help" || "$1" == "-h") then
    echo "This script is used to run test vector generation and testing for the scan path.\
          It must be called in the following format:\
          ./RUN_VECTOR {"opt" | "basic"} {clock period} ["pnr"]\
          where {} signify compulsary arguments.\
          \
          opt          - This specifies performing place and route on a synthesis/place and route that had opt set.\
          basic        - This specifies performing place and route on a synthesis/place and route that had basic set.\
          clock period - Specify here the integer value used as the clock period for synthesis/place and route.\
          pnr          - Specify this optional flag if you wish to perform this script on the netlist generated by\
                         place and route. Default is to use netlist generated by synthesis.\
          "
    exit
endif

if ($host != $hind && $host != $hart) then
    echo "Error: Vector Testing requires hind or hart CAD server for tools. Exiting..."
    exit 1
endif

if ("$1" != "opt" && "$1" != "basic") then
    echo "Error: Incorrect arguments given. See --help information."
    exit 1
endif

#if ("$2" != "[0-9]+") then
#    echo "Error: Incorrect arguments given. See --help information."
#    exit 1
#endif

if (${3} == "pnr") then
    echo "Using PNR";
    set pnr=1;
else
    echo "Using SYN";
    set pnr=0;
endif

cd work_${2}${1} >&/dev/null


echo "Generating scan path vectors..." | tee ../logs_${2}${1}/vector.log
source /home/esdcad/scripts/TetraMAX_H_2013_03_SP4

if ($pnr == 1) then
    tmax -shell -tcl "../vector_script_pnr.tcl" | tee -a ../logs_${2}${1}/vector_pnr.log
else
    tmax -shell -tcl "../vector_script.tcl" | tee -a ../logs_${2}${1}/vector_syn.log
endif

if ($? != 0) then
    echo "Error: Test vector generation failed. See log file for details."
    exit
endif


echo "Running scan path simulation..." | tee -a ../logs_${2}${1}/vector.log

setenv ESDCAD /home/esdcad
source /home/esdcad/scripts/synopsys_linux_vcs_D-2009.12
chmod +x patterns_vcs.sh
setenv STILDPV_HOME '/home/esdcad/software/synopsys/linux/TetraMAX_H_2013_03_SP4/linux/stildpv/'

./patterns_vcs.sh | tee -a ../logs_${2}${1}/vector.log

if ($? != 0) then
    echo "Error: Scan path simulation failed. See log file for details."
    exit
endif

echo "Scan path test complete. Results written to logs_${2}${1}/vector.log"
exit
