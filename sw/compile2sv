#!/bin/bash
#-------------------------------------------------------------------------------
# File          : compile2sv
# Description   : Script that compiles mips asm to a systemverilog array data.
# Primary Author: Lewis Russell
#-------------------------------------------------------------------------------

user=`whoami`
out="${1%.s}.sv"

rm -rf $out
mips-elf-gcc -Wa,-adhln -c -O -mips32 -EB $1 > $out

# Remove all lines that are labels
#sed -i '/:/d' $out
sed -i -r '/.*([0-9a-fA-F]{8})\s*([a-z]+)/!d' $out

# Format to sv array, e.g:
# 21 0010 34215678 	    ori     $1,  $1, 0x5678
# to...
# 32'h34215678, // ori $1, $1, 0x5678
sed -i -r 's/.*([0-9a-fA-F]{8})\s*([a-z]+)/32h'\''\1, \/\/ \2/g' $out

# Remove comma on last line.
sed -i '$s/,/ /g' $out

sed -i '1s/^/\/\/-------------------------------------------------------------------------------\n/g' $out
sed -i '2s/^/\/\/ File          : '$out'\n/g'     $out
sed -i '3s/^/\/\/ Description   : Systemverilog array data for asm generated from '$1'.\n/g' $out
sed -i '4s/^/\/\/ Primary Author: '$user'\n/g' $out
sed -i '5s/^/\/\/ Notes         : This file is automatically generated.\n/g' $out
sed -i '6s/^/\/\/-------------------------------------------------------------------------------\n/g' $out
